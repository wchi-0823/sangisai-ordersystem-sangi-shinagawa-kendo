<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ storeName or '模擬店 注文システム' }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .allergens-container { margin-top: 10px; font-size: 0.9em; color: #555; }
        .allergen-tag { display: inline-block; background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; padding: 2px 8px; margin-right: 5px; margin-bottom: 5px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        #set-modal-options table { width: 100%; border-collapse: collapse; }
        #set-modal-options th, #set-modal-options td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; }
        #set-modal-options input[type="checkbox"] { transform: scale(1.5); }
        .modal-actions { margin-top: 20px; text-align: right; display: flex; gap: 10px; justify-content: flex-end; }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            {% if storeLogoUrl %}<img src="{{ storeLogoUrl }}" alt="{{ storeName }} Logo" class="header-logo">{% endif %}
            <h1>{{ storeName or '商品メニュー' }}</h1>
        </div>
    </header>

    <main>
        <div id="toast" class="toast" style="top: 30px;"></div>
        <div id="category-filter" class="category-container">
            <button class="category-btn active" data-category="all">すべて</button>
            {% for category in categories %}<button class="category-btn" data-category="{{ category }}">{{ category }}</button>{% endfor %}
        </div>
        <div id="menu-items-list">
            {% for item in items %}
            <div class="card item-card" data-item-id="{{ item.ItemID }}" data-category="{{ item.get('category', '未分類') }}">
                {% if item.imageUrl %}<img src="{{ item.imageUrl }}" alt="{{ item.name }}" class="item-image">{% endif %}
                <div class="item-info">
                    <h2>{{ item.name }}</h2>
                    <p><strong>価格:</strong> {{ item.price }}円</p>
                    <p>{{ item.description }}</p>

                    {% if item.allergens and item.allergens|length > 0 %}
                    <div class="allergens-container">
                        <strong>アレルギー情報:</strong>
                        <div>{% for allergen in item.allergens %}<span class="allergen-tag">{{ allergen }}</span>{% endfor %}</div>
                    </div>
                    {% endif %}

                    {% if not item.isSoldOut %}
                        {% if item.isSet %}
                            <button class="select-set-btn" 
                                    data-item-id="{{ item.ItemID }}"
                                    data-item-name="{{ item.name }}" 
                                    data-item-price="{{ item.price }}"
                                    data-set-count="{{ item.setCount }}"
                                    data-set-items="{{ item.setItems|join(',') }}">
                                セット内容を選択する
                            </button>
                        {% else %}
                            <div class="quantity-selector">
                                <button class="quantity-minus">-</button>
                                <span class="quantity">1</span>
                                <button class="quantity-plus">+</button>
                            </div>
                            <button class="add-to-cart-btn" data-item-name="{{ item.name }}" data-item-price="{{ item.price }}">
                                カートに追加
                            </button>
                        {% endif %}
                    {% else %}
                        <p class="sold-out">売り切れ</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </main>

    <div class="fab-container">
        <a href="/cart" class="fab" aria-label="カートを確認する">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
        </a>
    </div>

    <div id="set-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="set-modal-title">セット内容を選択</h2>
            <p>合計 <strong id="set-modal-count" style="font-size: 1.2em;">0</strong> 個選択してください。（現在 <span id="set-modal-selected-count">0</span> 個選択中）</p>
            <div id="set-modal-options"></div>
            <div class="modal-actions">
                <button id="set-modal-cancel-btn" class="button-link" style="background-color: #6c757d;">キャンセル</button>
                <button id="set-modal-confirm-btn" disabled>決定</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>